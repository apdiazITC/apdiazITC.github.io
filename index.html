{% extends 'base/base.html' %}

{% block title %} {{ title }} {% endblock %}
 
{% block header %}	
	<div class="ps-2 pt-1"><h3> {{ text }} </h3></div>
	<div class="ps-3 pt-1 ms-1 mt-1"><h5> {{ subtext }} </h5></div>
	<div class="pt-1 ms-auto"> <span id='ct'  style="font-size: 19px;"></span> </div>
	
{% endblock %}

{% block extend_content %}
	<br>
	
	<div id="map"></div>
	
	<div class="row justify-content-center">
		<div class="col-1 ms-3 ps-4">
			<span class="material-icons" style="font-size:48px;">live_tv</span>
		</div>
	</div>
	
	{% for tdt in tdts %}
		
		<div class="row mt-4 ms-1">
			<hr size="2">
		</div>
		
		<div class="row mt-3 ms-1">
			<div class="col-3">
				<div class="fs-5 text-start"><b>{{ tdt.name }}</b></div>
			</div>
			<div class="col-4">
				<div class="fs-5 text-start"><b>{{ tdt.municipality }}</b></div>
			</div>
			<div class="col-4">
				<div class="fs-5 text-start"><b>{{ tdt.ip[7:] }} / {{ tdt.ip_record[7:] }}</b></div>
			</div>
			
			<!--
			<div class="col-2">
				<div class="fs-5 text-center"> Disponibilidad:  
					{% if tdt.sweepfree == True %} <b>Si</b>
					{% else %} <b>No</b>
					{% endif%}
				</div>
			</div>
			
			
			<div class="col-2">
				<div class="fs-5 text-center"> Barrido Automático:  
					{% if tdt.sweep_auto == True %} <b>Si</b>
					{% else %} <b>No</b>
					{% endif%}
				</div>
			</div>

			<div class="col-2">
				<div class="fs-5 text-end"> Hora Automático: <b>{{ tdt.sweeptime }}</b></div>
			</div>
			-->
			{% if session['username'] == 'Alejandro' %}
			<div class= 'col-1 text-end'>				
				<button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal{{tdt.name}}"><i class="bi bi-power"></i></button>	
			</div>
			{% endif %}
			<!-- Modal -->
			<div class="modal" id="modal{{tdt.name}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
			      		<div class="modal-header">
			        		<h5 class="modal-title text-center">Confirmación</h5>
			        		 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      		</div>
			      		
						<div class="modal-body">
							<p class="fs-5 text-center mt-1 p-1">¿Reiniciar {{tdt.name}}?</p>
			      		</div>

			      		<div class="modal-footer">
			        		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			        		<form action="{{ url_for ('data', device=tdt.name, param='reboot') }}" method="POST">
			        			<button type="submit" class="btn btn-secondary ms-3">Continuar</button>
			        		</form>
			      		</div>
			    	</div>
			  	</div>
			</div>		
			
		</div>
	{% endfor %}
		
		<div class="row mt-4 ms-1">
			<hr size="2">
		</div>
		
		<div class="row justify-content-center mt-4">
			<div class="col-1 ms-4 ps-4">
				<span class="material-icons" style="font-size:48px;">radio</span>
			</div>
		</div>
	{% for radio in radios %}
		
		<div class="row mt-4 ms-1">
			<hr size="2">
		</div>

		<div class="row mt-3 ms-1">
			
			<div class="col-3">
				<div class="fs-5 text-start"><b>{{ radio.name }}</b></div>
			</div>
			<div class="col-4">
				<div class="fs-5 text-start"><b>{{ radio.municipality }}</b></div>
			</div>
			<div class="col-4">
				<div class="fs-5 text-start"><b>{{ radio.ip[7:] }} / {{ radio.ip_record[7:] }}</b></div>
			</div>
			
			{% if session['username'] == 'Alejandro' %}
			<div class= 'col-1 text-end'>				
				<button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal{{radio.name}}"><i class="bi bi-power"></i></button>	
			</div>
			{% endif %}
			<!-- Modal -->
			<div class="modal" id="modal{{radio.name}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
			      		<div class="modal-header">
			        		<h5 class="modal-title text-center">Confirmación</h5>
			        		 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      		</div>
			      		
						<div class="modal-body">
							<p class="fs-5 text-center mt-1 p-1">¿Reiniciar {{radio.name}}?</p>
			      		</div>

			      		<div class="modal-footer">
			        		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			        		<form action="{{ url_for ('data', device=radio.name, param='reboot') }}" method="POST">
			        			<button type="submit" class="btn btn-secondary ms-3">Continuar</button>
			        		</form>
			      		</div>
			    	</div>
			  	</div>
			</div>		
			
		</div>
	{% endfor %}
	
	<div class="row mt-4 ms-1">
		<hr size="2">
	</div>
	
	<br><br><br>

	<script type="text/javascript" src="{{ url_for('static', filename='js/poblacion.js') }}" ></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/capa2.js') }}" ></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/canarias.js') }}" ></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/us-states.js') }}" ></script>	
	<script type="text/javascript">
	
    var southWest = L.latLng(26.010951, -24);
    var northEast = L.latLng(30.835566, -8);
    var bounds = L.latLngBounds(southWest, northEast);
	
	var map = L.map('map', {zoomControl: false, fullscreenControl: true,
		  fullscreenControlOptions: {
			    position: 'topleft'
			  }}).setView([28.35, -15.8], 8).setMaxBounds(bounds);
	
	map.on('drag', function() {
	    map.panInsideBounds(bounds, { animate: false });
	});
	
	var zoomHome = L.Control.zoomHome();
	zoomHome.addTo(map);
	
	//'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
	
	baselayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
		minZoom: 8,
	    maxZoom: 10,
	    attribution: '© OpenStreetMap',
	    maxBounds: bounds,
	    subdomains:['mt0','mt1','mt2','mt3']
	}).addTo(map);
	
	var list = "<dl><dt>Departamento</dt>"
        + "<dd>" + "Sociedad de Información" + "</dd>"
        + "<dt>Centro</dt>"
        + "<dd>" + 'Instituto Tecnológico de Canarias' + "</dd>"
        + "<dl><dt>Departamento</dt>"
        + "<dd>" + "Sociedad de Información" + "</dd>"
        + "<dt>Centro</dt>"
        + "<dd>" + 'Instituto Tecnológico de Canarias' + "</dd>"
        + "<dl><dt>Departamento</dt>"
        + "<dd>" + "Sociedad de Información" + "</dd>"
        + "<dt>Centro</dt>"
        + "<dd>" + 'Instituto Tecnológico de Canarias' + "</dd>"
        
   	//var marker = L.marker([28.472830864472606, -16.300387671175017]).addTo(map).bindPopup(list, {closeButton: false, maxHeight: 150});

	//map.addLayer(new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'));	//base layer
	
	function getColor(d) {
	    return d > 150000 ? '#800026' :
	           d > 100000  ? '#BD0026' :
	           d > 50000  ? '#E31A1C' :
	           d > 25000  ? '#FC4E2A' :
	           d > 10000   ? '#FD8D3C' :
	           d > 5000   ? '#FEB24C' :
	           d > 1000   ? '#FED976' :
	                      '#FFEDA0';
	}
	
    function styling(feature, year) {
 	    return {
 	        fillColor: getColor(feature.properties[year]),
 	        weight: 2,
 	        opacity: 1,
 	        color: 'black',
 	        //dashArray: '3',
 	        fillOpacity: 0.7
 	    };
 	}
    
    function onEachFeatured(feature, layer, years) {
	    // does this feature have a property named popupContent?
	    if (feature.properties && feature.properties.MUNICIPIO) {
	        
	    	var list = "<dl><dt>" + years + ":</dt>"
	            + "<dd>" + feature.properties[years] + "</dd>"
	        
            layer.bindPopup(list, {closeButton: false});
	        layer.bindTooltip(feature.properties.MUNICIPIO + '<br>' + feature.properties[years]);
	        
	        layer.on('mouseover', function (e) {
	        	info.update(layer.feature.properties, years);
	        	layer.openTooltip(e.latlng);
        	    this.setStyle({
	            	//'fillColor': '#00ffff',
	            	'weight': 4,
	            });
        	});
	        
	        layer.on('mouseout', function (e) {
	        	info.update();
	        	layer.closeTooltip();
	            this.setStyle({
	        		//'fillColor': '#00ffff',
	              	'weight': 2,
	            });
         	});
	        
	        layer.on('mousemove', function (e) {
	            e.target.closeTooltip();
	            var tooltip = e.target.getTooltip();
	            tooltip.setLatLng(e.latlng).openOn(map);
          	});
	        
	        layer.on('click', function (e) {
	        	map.setView(e.latlng, 10)
	        	//map.setZoom(10);
	        	//map.panTo(e.latlng);
	        	
          	});
	    }
	}

	var info = L.control();

	info.onAdd = function (map) {
	    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
	    this.update();
	    return this._div;
	};

	// method that we will use to update the control based on feature properties passed
	info.update = function (props, years) {
	    this._div.innerHTML = '<h4>Población</h4>' +  (props ?
	        '<b>' + props.MUNICIPIO + '</b><br />' + props[years]+ ' personas'
	        : 'Pasa el ratón por un municipio');
	};

	info.addTo(map);
    
	var layerControl = L.control.layers({'baselayer': baselayer}, null, {collapsed:false}).addTo(map);
	map.removeControl(layerControl);
	

	var fooLegend = L.control({position: 'topright'});
	
	fooLegend.onAdd = function () {
	      var div = L.DomUtil.create('div');
	   	  div.style.paddingTop = "0px";
	   	  div.style.marginTop = "0px"; 
	   	  div.style.paddingBottom = "2px"; 
	      div.innerHTML = "<dt>Años</dt>";
	      return div;
	};
	fooLegend.addTo(map);
		
	var layerControl2 = L.control.layers(null, null, {collapsed:false, sortLayers:true}).addTo(map);
	
	var fooCtrlDiv = layerControl2.getContainer();
	fooCtrlDiv.insertBefore(fooLegend.getContainer(), fooCtrlDiv.firstChild);
	
	//var years =  ['POB_2017', 'POB_2018', 'POB_2019', 'POB_2020', 'POB_2021'];
	var labels = ['POB_2017', 'H_2017', 'M_2017', 'POB_2018', 'H_2018', 'M_2018', 'POB_2019', 'H_2019', 'M_2019', 'POB_2020', 'H_2020', 'M_2020', 'POB_2021', 'H_2021', 'M_2021'];
	
	var sel1labels = ['2017', '2018', '2019', '2020', '2021']
	var sel2labels = ['Total', 'Hombres', 'Mujeres'];
	var sel2index = 0;			// Variable de control del segundo selector
	
	blanktile = L.tileLayer('', {minZoom: 8, maxZoom: 10, attribution: '© OpenStreetMap', maxBounds: bounds});
	
	sel1labels.forEach(function(year, index){
	   	var layer = L.geoJson(poblacion, {style: {weight: 0, fillOpacity: 0} });
    	
	    if(index==0){layer.addTo(map);}
    	layerControl2.addBaseLayer(layer, year);	
    });
	
	var fooLegend = L.control({position: 'topright'});
	
	fooLegend.onAdd = function () {
	      var div = L.DomUtil.create('div');
	   	  div.style.paddingTop = "0px";
	   	  div.style.marginTop = "0px"; 
	   	  div.style.paddingBottom = "2px"; 
	      div.innerHTML = "<dt>Categoría</dt>";
	      return div;
	};
	fooLegend.addTo(map);
	
	var layerControl3 = L.control.layers(null, null, {collapsed:false}).addTo(map);
	
	var fooCtrlDiv = layerControl3.getContainer();
	fooCtrlDiv.insertBefore(fooLegend.getContainer(), fooCtrlDiv.firstChild);
	
	var searchCurrent = [];
	var layersDict = {};
	var layersCurrent = [];
	var layerCurrent = [];
	
	labels.forEach(function(label, index){
	   	var layer = L.geoJson(poblacion, {
	 		style: function(feature){return styling(feature, label)},
	   		//filter: function(feature, layer){
	   			//console.log(feature.properties.ISLA == islands);
	   			//return feature.properties.ISLA == islands;},
	   		onEachFeature: function(feature, layer){onEachFeatured(feature, layer, label)} 
	   		});
	   		   	
		layersDict[label] = layer; 			// Diccionario con todas las capas existentes
	   	
	 	// Vector con las capas del segundo selector
	   	if (label.slice(-4) == '2017'){
	   		layersCurrent.push(layer);
	   		layerControl3.addBaseLayer(layer, sel2labels[index]);
	   		}		
	   	
		// Si primera iteracion, se añade capa al mapa y se guarda el buscador en uso
	   	if(index==0){
	   		
			var searchControl = new L.Control.Search({
				layer: layer,
				propertyName: 'MUNICIPIO',
				marker: false,
				moveToLocation: function(latlng, title, map) {
					//map.fitBounds( latlng.layer.getBounds() );
					var zoom = map.getBoundsZoom(latlng.layer.getBounds());
		  			map.setView(latlng, zoom); // access the zoom
				}
			});
			
			searchControl.on('search:locationfound', function(e) {
				e.layer.setStyle({fillColor: '#3f0', color: '#0f0'});
				e.layer.openPopup();
				e.layer.openTooltip();

			}).on('search:collapsed', function(e) {
				layerCurrent[0].resetStyle(e.layer);
			}).addTo(map);
			//layer.addTo(map);
			
			searchCurrent.push(searchControl);
			layerCurrent.push(layer);
	   		}
    });
	
	// Cambio en cualquier selector
	map.on('baselayerchange', function(e){
		
		for(var key in layersDict) {layersDict[key].resetStyle();}
		
		// Si primer selector
		if(sel1labels.indexOf(e.name) != -1){

			// Por cada capa del vector de actuales, del segundo selector, se borra el renderizado y del selector
			layersCurrent.forEach(function(layer, index){
				layer.remove();
				layerControl3.removeLayer(layer);				
				});
			
			layersCurrent = [];
			
			var i = 0;
			
			// Por cada capa del diccionario de las totales, se selecciona en base al primer selector
			for(var key in layersDict) {
				
				 // Si los ultimos 4 digitos coinciden con la etiqueta del anyo
				 if (key.slice(-4) == e.name){
					 
					// Se mantiene la seleccion del segundo selector
					if(i==sel2index){
						//console.log(e.name);
						layersDict[key].addTo(map);
						layerCurrent[0] = layersDict[key];
						searchCurrent[0].setLayer(layersDict[key]);
						}
					
					layersCurrent.push(layersDict[key]);			      // Se actualiza el vector de las capas actuales
					layerControl3.addBaseLayer(layersDict[key], sel2labels[i]); // Se actualiza el selector y las etiquetas
					i++;
				  }
				}
		// Si segundo selector
		}else{
			
			layerCurrent[0] = e.layer;
			searchCurrent[0].setLayer(e.layer);  // Se actualiza el buscador con la nueva capa del segundo selector
			sel2index = sel2labels.indexOf(e.name);   // Se actualiza la variable de control del segundo selector
		}

		// console.log(labels.filter(s => s.includes(e.name)));
		
	});
	
	// Leyenda
	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'info legend');
		var grades = [0, 1000, 5000, 10000, 25000, 50000, 100000, 150000];
		var labels = [];
		var from, to;

		for (var i = 0; i < grades.length; i++) {
			from = grades[i];
			to = grades[i + 1];

			labels.push(
				'<i style="background:' + getColor(from + 1) + '"></i> ' +
				from + (to ? '&ndash;' + to : '+'));
		}

		div.innerHTML = labels.join('<br>');
		return div;
	};

	legend.addTo(map);
	
	// Eliminar la atribucion del mapa
	$('.leaflet-control-attribution').hide()
	
	</script>

{% endblock %}